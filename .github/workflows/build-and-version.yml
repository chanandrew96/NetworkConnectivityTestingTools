name: Build, Version & Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write
      packages: read

    defaults:
      run:
        shell: pwsh
        working-directory: ${{ github.workspace }}

    env:
      PROJECT_FILE: NetworkConnectivityTestingTools.csproj   # 根目錄
      PUBLISH_DIR: publish                                     # 輸出到根目錄下的 publish/

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore ${{ env.PROJECT_FILE }}

      # 讀取目前版本（第一個 PropertyGroup）
      - name: Get current version
        id: get_version
        run: |
          $path = "$env:GITHUB_WORKSPACE\$env:PROJECT_FILE"
          if (-not (Test-Path $path)) {
            Write-Error "csproj not found: $path"
            exit 1
          }

          $xml = [Xml](Get-Content $path -Raw)
          $versionNode = $xml.Project.PropertyGroup[0].Version
          $version = if ($versionNode) { $versionNode.Trim() } else { "1.0" }
          
          Write-Host "Current version: $version"
          echo "CURRENT_VERSION=$version" >> $env:GITHUB_ENV

      # 計算新版本 +0.1
      - name: Calculate next version
        run: |
          $old = $env:CURRENT_VERSION
          $parts = $old -split '\.'
          $major = $parts[0]
          $minor = if ($parts[1]) { [int]$parts[1] } else { 0 }
          $newMinor = $minor + 1
          $newVersion = "$major.$newMinor"
          echo "NEW_VERSION=$newVersion" >> $env:GITHUB_ENV
          Write-Host "Bumping to: v$newVersion"

      # 更新第一個 PropertyGroup 的 <Version>
      - name: Update project version
        run: |
          $path = "$env:GITHUB_WORKSPACE\$env:PROJECT_FILE"
          $xml = [Xml](Get-Content $path -Raw)
          
          $pg = $xml.Project.PropertyGroup[0]
          if (-not $pg) {
            $pg = $xml.CreateElement("PropertyGroup")
            $xml.Project.AppendChild($pg) | Out-Null
          }
          
          $versionNode = $pg.SelectSingleNode("Version")
          if (-not $versionNode) {
            $versionNode = $xml.CreateElement("Version")
            $pg.AppendChild($versionNode) | Out-Null
          }
          
          $versionNode.InnerText = $env:NEW_VERSION
          $xml.Save($path)
          Write-Host "Updated version to: $env:NEW_VERSION"

      # 建置單檔（含所有資源）
      - name: Build & Publish
        run: |
          dotnet publish $env:PROJECT_FILE `
            -c Release `
            -r win-x64 `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:DebugType=none `
            -o $env:PUBLISH_DIR

      # 打包 ZIP（包含所有輸出）
      - name: Package Release
        run: |
          $zipName = "ConnTestLauncher-v$env:NEW_VERSION.zip"
          $source = "$env:GITHUB_WORKSPACE\$env:PUBLISH_DIR\*"
          Compress-Archive -Path $source -DestinationPath $zipName -Force
          echo "ASSET_PATH=$zipName" >> $env:GITHUB_ENV
          Write-Host "Packaged: $zipName"

      # 建立 GitHub Release（含 HKT 時間）
      - name: Create GitHub Release
        run: |
          $tag = "v$env:NEW_VERSION"
          $title = "ConnTestLauncher v$env:NEW_VERSION"
          $hktTime = (Get-Date).AddHours(8).ToString("yyyy-MM-dd HH:mm") + " HKT"
          $body = @"
          Auto-built on $hktTime

          **Features:**
          - Inbound & Outbound multi-config testing
          - CSV config import/export
          - HTML + CSV reports
          - Built with .NET 8 (win-x64 single file)

          **Files included:**
          - `ConnTestLauncher.exe`
          - `appsettings.json`
          - `scripts\*.ps1`
          - `configs\example.config.csv`

          [Download Here]($env:GITHUB_SERVER_URL/$env:GITHUB_REPOSITORY/releases/latest)
          "@

          gh release create $tag `
            --title "$title" `
            --notes "$body" `
            --target ${{ github.sha }} `
            "$env:ASSET_PATH"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 提交版本更新
      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add $env:PROJECT_FILE
          git commit -m "chore: bump version to v$env:NEW_VERSION [skip ci]" || echo "No changes"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
