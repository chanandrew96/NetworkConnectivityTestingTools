name: Build, Version & Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write   # 允許建立 Release
      packages: read

    defaults:
      run:
        shell: pwsh
        working-directory: ${{ github.workspace }}

    env:
      PROJECT_FILE: NetworkConnectivityTestingTools.csproj
      PUBLISH_DIR: publish

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore ${{ env.PROJECT_FILE }}

      # 讀取目前版本
      - name: Get current version
        id: get_version
        run: |
          $path = "$env:GITHUB_WORKSPACE\$env:PROJECT_FILE"
          if (-not (Test-Path $path)) {
            Write-Error "csproj not found: $path"
            exit 1
          }
          $xml = [Xml](Get-Content $path -Raw)
          $version = $xml.Project.PropertyGroup.Version
          if (-not $version) { $version = "1.0" }
          Write-Host "Current version: $version"
          echo "CURRENT_VERSION=$version" >> $env:GITHUB_ENV

      # 計算新版本 +0.1
      - name: Calculate next version
        run: |
          $old = $env:CURRENT_VERSION
          $parts = $old -split '\.'
          $major = $parts[0]
          $minor = if ($parts[1]) { [int]$parts[1] } else { 0 }
          $newMinor = $minor + 1
          $newVersion = "$major.$newMinor"
          echo "NEW_VERSION=$newVersion" >> $env:GITHUB_ENV
          Write-Host "Bumping to: v$newVersion"

      # 更新 csproj 版本
      - name: Update project version
        run: |
          $path = "$env:GITHUB_WORKSPACE\$env:PROJECT_FILE"
          $xml = [Xml](Get-Content $path -Raw)
          $xml.Project.PropertyGroup.Version = $env:NEW_VERSION
          $xml.Save($path)

      # 建置單檔
      - name: Build & Publish
        run: |
          dotnet publish $env:PROJECT_FILE `
            -c Release `
            -r win-x64 `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -o $env:PUBLISH_DIR

      # 打包 ZIP
      - name: Package Release
        run: |
          $zipName = "ConnTestLauncher-v$env:NEW_VERSION.zip"
          $source = "$env:GITHUB_WORKSPACE\$env:PUBLISH_DIR\*"
          Compress-Archive -Path $source -DestinationPath $zipName -Force
          echo "ASSET_PATH=$zipName" >> $env:GITHUB_ENV
          Write-Host "Packaged: $zipName"

      # 建立 GitHub Release
      - name: Create GitHub Release
        run: |
          $tag = "v$env:NEW_VERSION"
          $title = "ConnTestLauncher v$env:NEW_VERSION"
          $hktTime = (Get-Date).ToString("yyyy-MM-dd HH:mm") + " HKT"
          $body = @"
          Auto-built on $hktTime

          **Changes:**
          - Version bump
          - Built with .NET 8 (win-x64)

          [Download Here]($env:GITHUB_SERVER_URL/$env:GITHUB_REPOSITORY/releases/latest)
          "@

          gh release create $tag `
            --title "$title" `
            --notes "$body" `
            --target ${{ github.sha }} `
            "$env:ASSET_PATH"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 提交版本更新
      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add $env:PROJECT_FILE
          git commit -m "chore: bump version to v$env:NEW_VERSION [skip ci]" || echo "No changes"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
