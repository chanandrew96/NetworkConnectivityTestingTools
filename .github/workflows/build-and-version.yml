name: Build & Auto-Version

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    env:
      PROJECT_FILE: ConnTestLauncher.csproj
      PUBLISH_DIR: ./publish

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore

      # 讀取目前版本
      - name: Get current version
        id: get_version
        shell: pwsh
        run: |
          $xml = [Xml](Get-Content ${{ env.PROJECT_FILE }})
          $version = $xml.Project.PropertyGroup.Version
          if (-not $version) { $version = "1.0" }
          Write-Host "Current version: $version"
          echo "CURRENT_VERSION=$version" >> $env:GITHUB_ENV

      # 計算新版本 +0.1
      - name: Calculate next version
        shell: pwsh
        run: |
          $old = $env:CURRENT_VERSION
          $parts = $old -split '\.'
          $major = $parts[0]
          $minor = [int]$parts[1]
          if (-not $minor) { $minor = 0 }
          $newMinor = $minor + 1
          $newVersion = "$major.$newMinor"
          echo "NEW_VERSION=$newVersion" >> $env:GITHUB_ENV
          Write-Host "Bumping to: $newVersion"

      # 更新 csproj
      - name: Update project version
        shell: pwsh
        run: |
          $xml = [Xml](Get-Content ${{ env.PROJECT_FILE }})
          $xml.Project.PropertyGroup.Version = $env:NEW_VERSION
          $xml.Save("$PWD/${{ env.PROJECT_FILE }}")

      # 建置
      - name: Build & Publish
        run: |
          dotnet publish -c Release -r win-x64 --self-contained true `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -o ${{ env.PUBLISH_DIR }}

      # 打包
      - name: Create Artifact
        shell: pwsh
        run: |
          $zipName = "ConnTestLauncher-v$env:NEW_VERSION.zip"
          Compress-Archive -Path ${{ env.PUBLISH_DIR }}/* -DestinationPath $zipName
          echo "ARTIFACT_NAME=$zipName" >> $env:GITHUB_ENV

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ConnTestLauncher-v${{ env.NEW_VERSION }}
          path: ConnTestLauncher-v${{ env.NEW_VERSION }}.zip
          retention-days: 7

      # 提交版本變更
      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ env.PROJECT_FILE }}
          git commit -m "chore: bump version to $env:NEW_VERSION [skip ci]" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
